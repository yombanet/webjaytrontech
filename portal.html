<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tiara-1 System â€” Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{
      padding:1.25rem;
      background:#0b0b0b;
      color:#fff;
      background-image: url("img/fleetmanagement.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      margin:0;
    }
    .overlay {
      background: rgba(0,0,0,0.45);
      min-height: 100vh;
      padding-top: 1rem;
      padding-bottom: 1rem;
    }
    .card{background:#0f1720}
    .portal-logo{max-width:220px;height:auto;display:block;margin:0 auto}
    .api-status{font-size:.9rem;color:#ddd;margin-bottom:.75rem;text-align:center}
    pre.logbox{background:#021;color:#b7ffd8;padding:.5rem;border-radius:.25rem;max-height:200px;overflow:auto;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="overlay">
  <div class="container">
    <div class="text-center mb-3">
      <img src="img/img3.png" alt="Tiara-1 logo" class="portal-logo img-fluid">
      <h1 class="h4 mt-2">Tiara-1 System</h1>
      <div id="apiStatus" class="api-status">Connecting to portal...</div>
    </div>

    <div id="authBox" class="card p-3 mb-3">
      <div class="d-flex gap-2">
        <input id="username" class="form-control" placeholder="username (admin/operator/user)" value="admin">
        <input id="password" class="form-control" placeholder="password" value="admin" type="password">
        <button id="loginBtn" class="btn btn-primary">Login</button>
        <button id="loginAdminBtn" class="btn btn-outline-light" title="Quick admin login">Admin</button>
        <button id="logoutBtn" class="btn btn-secondary d-none">Logout</button>
      </div>
      <div id="userInfo" class="mt-2 small text-muted"></div>
    </div>

    <div id="mainUI" class="d-none">
      <div class="d-flex justify-content-between mb-2">
        <h4>Devices</h4>
        <div>
          <input id="newDeviceName" placeholder="new device name" class="form-control d-inline-block" style="width:220px">
          <button id="addDeviceBtn" class="btn btn-success">Add Device</button>
        </div>
      </div>

      <div id="devicesList" class="row g-3 mb-3"></div>

      <h5>Logs (RFID)</h5>
      <pre id="rfidLogs" class="logbox">No logs yet</pre>

      <h5>Fuel Logs</h5>
      <pre id="fuelLogs" class="logbox">No logs yet</pre>
    </div>
  </div>
  </div>

<script>
/* Configuration */
const API = 'http://localhost:3001/api';
const WS_URL = 'ws://localhost:3001';
let token = null;
let currentUser = null;
let ws = null;

/* Apply auth state and initialize realtime if needed */
function setAuth(t, user) {
  token = t || null;
  currentUser = user || null;
  localStorage.setItem('jt_token', token || '');
  localStorage.setItem('jt_user', JSON.stringify(currentUser || null));
  document.getElementById('logoutBtn').classList.toggle('d-none', !token);
  document.getElementById('loginBtn').classList.toggle('d-none', !!token);
  document.getElementById('loginAdminBtn').classList.toggle('d-none', !!token);
  document.getElementById('authBox').querySelector('#username').disabled = !!token;
  document.getElementById('authBox').querySelector('#password').disabled = !!token;
  document.getElementById('userInfo').textContent = currentUser ? `${currentUser.username} (${currentUser.role})` : '';
  document.getElementById('mainUI').classList.toggle('d-none', !token);

  if (token) {
    connectWS();
    loadDevices();
    if (currentUser && (currentUser.role === 'OPERATOR' || currentUser.role === 'ADMIN')) requestLogs();
  } else {
    closeWS();
    document.getElementById('rfidLogs').textContent = 'Operator+ only';
    document.getElementById('fuelLogs').textContent = 'Operator+ only';
  }
}

/* Login */
async function doLogin(u,p){
  try{
    const r = await fetch(API + '/login', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({username:u,password:p})});
    const j = await r.json();
    if (r.ok) {
      setAuth(j.token, j.user);
    } else {
      alert(j.error || 'Login failed');
    }
  }catch(err){
    alert('Unable to reach portal API');
  }
}

document.getElementById('loginBtn').addEventListener('click', async () => {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  await doLogin(u,p);
});
document.getElementById('loginAdminBtn').addEventListener('click', async () => {
  document.getElementById('username').value = 'admin';
  document.getElementById('password').value = 'admin';
  await doLogin('admin','admin');
});
document.querySelectorAll('#username,#password').forEach(el=>{
  el.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ document.getElementById('loginBtn').click(); }});
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  try{ await fetch(API + '/logout', { method:'POST', headers:{ Authorization: 'Bearer ' + token }}); }catch(e){}
  setAuth(null, null);
});

/* Add device (ADMIN) */
document.getElementById('addDeviceBtn').addEventListener('click', async () => {
  const name = document.getElementById('newDeviceName').value.trim();
  if (!name) return alert('Enter name');
  const r = await fetch(API + '/devices', { method:'POST', headers:{ 'content-type':'application/json', Authorization: 'Bearer ' + token }, body: JSON.stringify({ name })});
  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Failed');
  document.getElementById('newDeviceName').value = '';
  loadDevices();
});

/* Load devices and attach controls */
async function loadDevices() {
  try {
    const r = await fetch(API + '/devices', { headers:{ Authorization: 'Bearer ' + token }});
    const list = await r.json();
    const container = document.getElementById('devicesList');
    container.innerHTML = '';
    list.forEach(d => {
      const col = document.createElement('div'); col.className = 'col-12 col-md-6';
      col.innerHTML = `
        <div class="card p-2">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>${d.name}</strong><div class="small text-muted">id: ${d.id}</div>
              <div class="small">Last seen: ${d.lastSeen || 'never'}</div>
              <div class="small">Valve: ${d.valveState}</div>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-success me-1" data-id="${d.id}" data-cmd="open">OPEN</button>
              <button class="btn btn-sm btn-outline-danger me-1" data-id="${d.id}" data-cmd="close">CLOSE</button>
              <button class="btn btn-sm btn-outline-secondary" data-id="${d.id}" data-action="refresh">Refresh</button>
            </div>
          </div>
        </div>`;
      container.appendChild(col);
    });

    container.querySelectorAll('button[data-cmd]').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        const id = btn.dataset.id, cmd = btn.dataset.cmd;
        const r = await fetch(API + '/devices/'+id+'/command', {
          method:'POST',
          headers:{ 'content-type':'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify({ cmd })
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Failed');
        alert('Command queued');
        loadDevices();
      });
    });
    container.querySelectorAll('button[data-action="refresh"]').forEach(b=>{
      b.addEventListener('click', async () => { const id=b.dataset.id; const r=await fetch(API+'/devices/'+id+'/status',{headers:{Authorization:'Bearer '+token}}); const j=await r.json(); if(r.ok) { alert(JSON.stringify(j, null, 2)); loadDevices(); } else alert(j.error||'err'); });
    });

    if (currentUser && (currentUser.role === 'OPERATOR' || currentUser.role === 'ADMIN')) {
      const rf = await fetch(API + '/logs/rfid', { headers:{ Authorization: 'Bearer ' + token }});
      const fl = await fetch(API + '/logs/fuel', { headers:{ Authorization: 'Bearer ' + token }});
      document.getElementById('rfidLogs').textContent = JSON.stringify(await rf.json(), null, 2);
      document.getElementById('fuelLogs').textContent = JSON.stringify(await fl.json(), null, 2);
    } else {
      document.getElementById('rfidLogs').textContent = 'Operator+ only';
      document.getElementById('fuelLogs').textContent = 'Operator+ only';
    }
  } catch (e) {
    console.error(e);
  }
}

/* Request logs over WS (operator/admin) */
function requestLogs() {
  if (!ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: 'request_logs' }));
}

/* WebSocket realtime */
function appendLog(elId, text){
  const el = document.getElementById(elId);
  el.textContent = text + '\n' + el.textContent;
}

function connectWS() {
  if (ws) return;
  try {
    ws = new WebSocket(`${WS_URL}?token=${encodeURIComponent(token)}`);
  } catch (e) { return; }

  ws.addEventListener('open', () => {
    const s = document.getElementById('apiStatus');
    s.textContent = 'Realtime connected';
    s.style.color = '#b7ffb8';
  });

  ws.addEventListener('message', msg => {
    try {
      const data = JSON.parse(msg.data);
      if (data.type === 'welcome') {
        // initial welcome
      } else if (data.type === 'devices_snapshot') {
        if (token) loadDevices();
      } else if (data.type === 'telemetry' || data.type === 'device_added' || data.type === 'command_issued') {
        loadDevices();
      } else if (data.type === 'rfid') {
        appendLog('rfidLogs', JSON.stringify(data, null, 2));
      } else if (data.type === 'fuel') {
        appendLog('fuelLogs', JSON.stringify(data, null, 2));
      } else if (data.type === 'logs_snapshot') {
        document.getElementById('rfidLogs').textContent = JSON.stringify(data.rfid || [], null, 2);
        document.getElementById('fuelLogs').textContent = JSON.stringify(data.fuel || [], null, 2);
      }
    } catch (e) {}
  });

  ws.addEventListener('close', () => {
    const s = document.getElementById('apiStatus');
    s.textContent = 'Realtime disconnected';
    s.style.color = '#ffd400';
    ws = null;
    setTimeout(()=>{ if (token) connectWS(); }, 1500);
  });

  ws.addEventListener('error', () => {
    const s = document.getElementById('apiStatus');
    s.textContent = 'Realtime error';
    s.style.color = '#ff9b9b';
  });
}

function closeWS() {
  if (ws) {
    try { ws.close(); } catch(e){}
    ws = null;
  }
}

/* API connectivity check */
async function checkApi() {
  const statusEl = document.getElementById('apiStatus');
  try{
    const r = await fetch(API + '/devices', { method:'GET' });
    if (r.ok || r.status === 401) {
      statusEl.textContent = 'Portal API reachable';
      statusEl.style.color = '#b7ffb8';
    } else {
      statusEl.textContent = 'Portal API responded: ' + r.status;
      statusEl.style.color = '#ffd400';
    }
  }catch(err){
    statusEl.textContent = 'Portal API unreachable (check server)';
    statusEl.style.color = '#ff9b9b';
  }
}

/* Restore auth from localStorage */
setAuth(localStorage.getItem('jt_token') || null, JSON.parse(localStorage.getItem('jt_user') || 'null'));
checkApi();
</script>
</body>
</html>